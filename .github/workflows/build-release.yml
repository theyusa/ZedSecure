name: Build & Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: false
      
      - name: Flutter Doctor
        run: flutter doctor -v
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
      
      - name: Build Release APKs (Split)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          flutter build apk --release --split-per-abi \
            --target-platform android-arm,android-arm64,android-x64
      
      - name: Build Universal APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          flutter build apk --release
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v1.8.1"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-apks
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-x86_64.apk
          cp build/app/outputs/flutter-apk/app-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-universal.apk
      
      - name: Upload ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-arm64-v8a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
      
      - name: Upload ARMv7 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-armeabi-v7a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
      
      - name: Upload x86_64 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-x86_64
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-x86_64.apk
      
      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-universal
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-universal.apk
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-x86_64.apk
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-universal.apk
          body: |
            ## ZedSecure VPN ${{ steps.version.outputs.version }}
            
            ### Downloads
            
            | Architecture | File | Devices |
            |-------------|------|---------|
            | ARM64-v8a | `ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk` | Modern devices (2015+) - **Recommended** |
            | ARMv7a | `ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk` | Older devices |
            | x86_64 | `ZedSecure-${{ steps.version.outputs.version }}-x86_64.apk` | Emulators/x86 devices |
            | Universal | `ZedSecure-${{ steps.version.outputs.version }}-universal.apk` | All devices (larger size) |
            
            ### What's New in v1.8.1
            
            #### üêõ Bug Fixes
            - **Ping After Connection**: Fixed ping measurement showing "Measuring..." indefinitely
              - Implemented IPC (Inter-Process Communication) for cross-process core access
              - Changed from direct core access to Intent-based method
              - Increased timeout from 3s to 15s for better reliability
            - **Multiple Ping Requests**: Fixed excessive ping requests causing performance issues
              - Moved GlobalKey to State class to prevent recreation on rebuild
              - Now pings only once on connection with manual refresh button
            - **Custom Config Connection**: Fixed custom JSON configs from subscriptions failing to connect
            - **Custom Config Traffic Stats**: Fixed upload/download statistics for custom configs
            - **Custom Config Ping Test**: Fixed ping test failure for custom JSON configs
            - **Advanced Settings Dependencies**: Local DNS/Fake DNS dependency logic improved
            
            #### üîß Technical Changes
            - Updated Xray-core to 26.2.4
            - Implemented proper IPC for V2Ray Core communication
            - Enhanced V2rayController with URL parameter support
            - Improved config builder logic for custom JSON handling
            - Added comprehensive logging for debugging
            
            ### Installation
            
            1. Download the appropriate APK for your device
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Grant VPN and notification permissions
            
            ### Acknowledgments
            
            - [hev-socks5-tunnel](https://github.com/heiher/hev-socks5-tunnel/) - High-performance TUN implementation
            
            ---
            
            **Telegram**: https://t.me/CluvexStudio
            
            Developed by CluvexStudio
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
