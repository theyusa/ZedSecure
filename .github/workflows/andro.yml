name: Build & Release APK (Pre-release - ARM64 Only)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Pre-release APK (ARM64)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        run: flutter doctor -v
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Build Debug APK - ARM64 Only
        run: |
          flutter build apk --debug --target-platform android-arm64
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v1.8.0-pre"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-apks
          cp build/app/outputs/flutter-apk/app-debug.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a-debug.apk
      
      - name: Upload ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-arm64-v8a-debug
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a-debug.apk
      
      - name: Create GitHub Pre-release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          files: |
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a-debug.apk
          body: |
            ## ðŸ§ª ZedSecure VPN ${{ steps.version.outputs.version }} - Pre-release (Debug Build)
            
            > âš ï¸ **WARNING**: This is a DEBUG build for testing purposes only!
            > - Not optimized for performance
            > - Contains debugging symbols
            > - Larger file size
            > - Should NOT be used in production
            > - **ARM64 ONLY** - Works on modern devices (2015+)
            
            ### Download
            
            | Architecture | File | Devices |
            |-------------|------|---------|
            | ARM64-v8a | `ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a-debug.apk` | Modern devices (2015+) |
            
            
            ### Testing Notes
            
            - This is a debug build signed with debug keys
            - **Fast build** - Only ARM64 architecture for quick testing
            - Use this for testing before creating a production release
            - Performance may be slower than release builds
            - If your device is older than 2015, you may need a different build
            
            ### Acknowledgments
            
            - [hev-socks5-tunnel](https://github.com/heiher/hev-socks5-tunnel/) - High-performance TUN implementation
            
            ---
            
            **Telegram**: https://t.me/CluvexStudio
            
            Developed by CluvexStudio
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
