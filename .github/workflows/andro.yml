name: Build & Release APK (Optimized - ARM64)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version Tag (e.g., v1.8.2-pre)'
        required: false
        default: ''
      release_name:
        description: 'Release Name'
        required: false
        default: ''

jobs:
  build:
    name: Build & Release ARM64
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Get Version Info
        id: version_info
        run: |
          # 1. Determine Tag
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.version_tag }}" != "" ]; then
            TAG="${{ github.event.inputs.version_tag }}"
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            TAG="${{ github.ref_name }}"
          else
            # Fallback: Get version from pubspec.yaml
            PUBSPEC_VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
            TAG="v${PUBSPEC_VERSION}-pre"
          fi
          
          # 2. Determine Release Name
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.release_name }}" != "" ]; then
            NAME="${{ github.event.inputs.release_name }}"
          else
            NAME="ZedSecure $TAG"
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "Using Tag: $TAG"
          echo "Using Name: $NAME"

      - name: Build Release APK (Optimized ARM64)
        run: |
          # Step 1 recommendation: Using --release for optimization and smaller size
          flutter build apk --release --target-platform android-arm64 --obfuscate --split-debug-info=build/app/outputs/symbols
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-apks
          # Find the built apk (usually app-release.apk when built with --release)
          cp build/app/outputs/flutter-apk/app-release.apk release-apks/ZedSecure-${{ steps.version_info.outputs.tag }}-arm64-v8a.apk
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-arm64-v8a
          path: release-apks/ZedSecure-${{ steps.version_info.outputs.tag }}-arm64-v8a.apk
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.tag }}
          name: ${{ steps.version_info.outputs.name }}
          prerelease: true
          files: |
            release-apks/ZedSecure-${{ steps.version_info.outputs.tag }}-arm64-v8a.apk
          body: |
            ## ðŸš€ ${{ steps.version_info.outputs.name }}
            
            Optimized ARM64 build.
            
            ### ðŸ›  Build Info
            - **Mode**: Release (Optimized)
            - **Architecture**: ARM64-v8a Only
            - **Version**: ${{ steps.version_info.outputs.tag }}
            
            ### ðŸ“¦ Files
            - `ZedSecure-${{ steps.version_info.outputs.tag }}-arm64-v8a.apk`
            
            ---
            **Telegram**: https://t.me/CluvexStudio
            Developed by CluvexStudio
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
